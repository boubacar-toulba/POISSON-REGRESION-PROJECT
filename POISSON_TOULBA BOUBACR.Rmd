---
title: "Application de la RÃ©gression de Poisson"
author: "TOULBA Boubacar et CEMLLAL ISMAIL "
date: "`r Sys.Date()`"
output: html_document
---

```{r}
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  0. LIBRARIES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
libs <- c("readxl", "dplyr", "ggplot2", "pROC", "broom", "corrplot", 
          "gridExtra", "knitr", "car", "RColorBrewer", "viridis")
to_install <- setdiff(libs, rownames(installed.packages()))
if (length(to_install)) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}
invisible(lapply(libs, library, character.only = TRUE))

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  1. CONFIGURATION  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
# Chemins des fichiers - Ã€ ADAPTER selon votre environnement
data_path <- "D:/s4 partie2/GLM/GLM POSONN/competition_awards_data.xlsx"
out_dir <- "D:/s4 partie2/GLM/GLM POSONN/PICSSS"

# Palette de couleurs personnalisÃ©e
colors_palette <- list(
  primary = "#2E86AB",      # Bleu professionnel
  secondary = "#F24236",    # Rouge vibrant
  accent = "#F6AE2D",       # Jaune dorÃ©
  success = "#2F9B69",      # Vert succÃ¨s
  warning = "#F18F01",      # Orange
  info = "#A23B72",         # Violet
  light_blue = "#87CEEB",   # Bleu clair
  dark_blue = "#1E5F8B",    # Bleu foncÃ©
  gradient = c("#2E86AB", "#A23B72", "#F24236", "#F6AE2D", "#2F9B69")
)

# CrÃ©ation du dossier de sortie
if (!dir.exists(out_dir)) {
  dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
}

# Test des permissions d'Ã©criture
test_file <- file.path(out_dir, "write_test.tmp")
test_ok <- tryCatch({
  writeLines("Test", test_file)
  TRUE
}, error = function(e) FALSE)

if (!test_ok) {
  stop("âŒmpossible d'Ã©crire dans le dossier de sortie. VÃ©rifiez le chemin.")
}
unlink(test_file)

cat("âœ… Dossier de sortie configurÃ© :", out_dir, "\n")
cat("=" %+% paste(rep("=", 60), collapse = ""), "\n")
cat("                    ANALYSE DE RÃ‰GRESSION DE POISSON\n")
cat("=" %+% paste(rep("=", 60), collapse = ""), "\n\n")

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  2. IMPORT ET EXPLORATION DES DONNÃ‰ES  â”€â”€â”€â”€ ##
set.seed(123)  # Pour la reproductibilitÃ©

cat("ðŸ“Š Ã‰TAPE 1: IMPORT ET EXPLORATION DES DONNÃ‰ES\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# Import des donnÃ©es Excel
if (grepl("\\.xlsx$", data_path, ignore.case = TRUE)) {
  df <- read_xlsx(data_path)
} else if (grepl("\\.xls$", data_path, ignore.case = TRUE)) {
  df <- read_xls(data_path)
} else {
  stop("Le fichier doit Ãªtre au format .xls ou .xlsx")
}

cat("âœ… DonnÃ©es importÃ©es :", nrow(df), "observations,", ncol(df), "variables\n\n")

# Description des donnÃ©es
cat("ðŸ“‹ STRUCTURE DES DONNÃ‰ES :\n")
str(df)
cat("\nðŸ“Š STATISTIQUES DESCRIPTIVES :\n")
print(summary(df))

# Distribution de la variable rÃ©ponse
cat("\nðŸŽ¯ DISTRIBUTION DE LA VARIABLE RÃ‰PONSE (Awards) :\n")
awards_table <- table(df$Awards)
print(awards_table)
cat("Moyenne :", round(mean(df$Awards), 3), "\n")
cat("Variance :", round(var(df$Awards), 3), "\n")
cat("Ratio Variance/Moyenne :", round(var(df$Awards)/mean(df$Awards), 3), "\n\n")

# VÃ©rification des valeurs manquantes
cat("ðŸ” VALEURS MANQUANTES :\n")
na_count <- sapply(df, function(x) sum(is.na(x)))
print(na_count[na_count > 0])
if(sum(na_count) == 0) cat("Aucune valeur manquante dÃ©tectÃ©e.\n")

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  3. DIVISION DES DONNÃ‰ES (80/20)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ“Š Ã‰TAPE 2: DIVISION DES DONNÃ‰ES\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

n <- nrow(df)
train_idx <- sample(seq_len(n), size = floor(0.8 * n))
df_train <- df[train_idx, ]
df_valid <- df[-train_idx, ]

cat("Ã‰chantillon d'apprentissage :", nrow(df_train), "observations (80%)\n")
cat("Ã‰chantillon de validation :", nrow(df_valid), "observations (20%)\n\n")

# VÃ©rification de la distribution dans chaque Ã©chantillon
cat("Distribution des Awards dans l'Ã©chantillon d'apprentissage :\n")
print(table(df_train$Awards))
cat("\nDistribution des Awards dans l'Ã©chantillon de validation :\n")
print(table(df_valid$Awards))

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  4. AJUSTEMENT DU MODÃˆLE  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ”§ Ã‰TAPE 3: AJUSTEMENT DU MODÃˆLE DE RÃ‰GRESSION DE POISSON\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# ModÃ¨le complet
cat("Ajustement du modÃ¨le complet...\n")
mod_complet <- glm(Awards ~ ., data = df_train, family = poisson(link = "log"))

# RÃ©sumÃ© du modÃ¨le
cat("\nðŸ“‹ RÃ‰SUMÃ‰ DU MODÃˆLE COMPLET :\n")
summary_mod <- summary(mod_complet)
print(summary_mod)

# SÃ©lection de variables (si nÃ©cessaire)
cat("\nðŸ” SÃ‰LECTION DE VARIABLES (AIC) :\n")
mod_optimal <- step(mod_complet, trace = FALSE)
cat("Variables retenues dans le modÃ¨le optimal :\n")
print(names(coef(mod_optimal)))

# Comparaison des modÃ¨les
cat("\nðŸ“Š COMPARAISON DES MODÃˆLES :\n")
aic_comparison <- AIC(mod_complet, mod_optimal)
print(aic_comparison)

# Utilisation du modÃ¨le optimal pour la suite
mod_final <- mod_optimal

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  5. TEST D'ADÃ‰QUATION DU MODÃˆLE  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ§ª Ã‰TAPE 4: TESTS D'ADÃ‰QUATION DU MODÃˆLE\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# Test de sur-dispersion
phi <- sum(residuals(mod_final, type = "pearson")^2) / mod_final$df.residual
cat("ParamÃ¨tre de dispersion (Ï†) :", round(phi, 4), "\n")

if (phi > 1.5) {
  cat("âš   SUR-DISPERSION dÃ©tectÃ©e (Ï† > 1.5)\n")
  cat("   Recommandation : ConsidÃ©rer un modÃ¨le Binomial NÃ©gatif\n")
} else if (phi < 0.8) {
  cat("âš   SOUS-DISPERSION dÃ©tectÃ©e (Ï† < 0.8)\n")
} else {
  cat("âœ… Dispersion acceptable pour le modÃ¨le de Poisson\n")
}

# Test de Hosmer-Lemeshow adaptÃ© pour Poisson
cat("\nðŸ”¬ AUTRES TESTS D'ADÃ‰QUATION :\n")
# DÃ©viance rÃ©siduelle
dev_residual <- mod_final$deviance
df_residual <- mod_final$df.residual
p_value_dev <- pchisq(dev_residual, df_residual, lower.tail = FALSE)
cat("Test de dÃ©viance rÃ©siduelle :\n")
cat("  DÃ©viance :", round(dev_residual, 3), "\n")
cat("  DegrÃ©s de libertÃ© :", df_residual, "\n")
cat("  p-value :", round(p_value_dev, 4), "\n")

if (p_value_dev < 0.05) {
  cat("  InterprÃ©tation : Le modÃ¨le ne s'ajuste pas parfaitement (p < 0.05)\n")
} else {
  cat("  InterprÃ©tation : Le modÃ¨le s'ajuste correctement (p â‰¥ 0.05)\n")
}

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  6. PRÃ‰DICTIONS ET Ã‰VALUATION  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸŽ¯ Ã‰TAPE 5: PRÃ‰DICTIONS ET Ã‰VALUATION\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# PrÃ©dictions
pred_train <- predict(mod_final, type = "response")
pred_valid <- predict(mod_final, newdata = df_valid, type = "response")

# MÃ©triques de performance
mse_train <- mean((df_train$Awards - pred_train)^2)
mse_valid <- mean((df_valid$Awards - pred_valid)^2)
mae_train <- mean(abs(df_train$Awards - pred_train))
mae_valid <- mean(abs(df_valid$Awards - pred_valid))

r2_train <- 1 - (sum((df_train$Awards - pred_train)^2) / 
                   sum((df_train$Awards - mean(df_train$Awards))^2))
r2_valid <- 1 - (sum((df_valid$Awards - pred_valid)^2) / 
                   sum((df_valid$Awards - mean(df_valid$Awards))^2))

cat("ðŸ“Š MÃ‰TRIQUES DE PERFORMANCE :\n")
cat("Apprentissage - MSE:", round(mse_train, 3), "| MAE:", round(mae_train, 3), 
    "| RÂ²:", round(r2_train, 3), "\n")
cat("Validation    - MSE:", round(mse_valid, 3), "| MAE:", round(mae_valid, 3), 
    "| RÂ²:", round(r2_valid, 3), "\n")

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  7. ANALYSE ROC  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ“ˆ Ã‰TAPE 6: ANALYSE ROC\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# Transformation pour l'analyse ROC : probabilitÃ© d'avoir au moins 1 prix
prob_train <- 1 - dpois(0, pred_train)
prob_valid <- 1 - dpois(0, pred_valid)

# Variables binaires : au moins 1 prix
y_binary_train <- as.numeric(df_train$Awards > 0)
y_binary_valid <- as.numeric(df_valid$Awards > 0)

# Courbes ROC
roc_train <- roc(y_binary_train, prob_train, quiet = TRUE)
roc_valid <- roc(y_binary_valid, prob_valid, quiet = TRUE)

auc_train <- auc(roc_train)
auc_valid <- auc(roc_valid)

cat("ðŸ“Š RÃ‰SULTATS DE L'ANALYSE ROC :\n")
cat("AUC Apprentissage :", round(auc_train, 3), "\n")
cat("AUC Validation    :", round(auc_valid, 3), "\n")

# InterprÃ©tation de l'AUC
if (auc_valid >= 0.9) {
  cat("âœ… Excellente capacitÃ© de discrimination (AUC â‰¥ 0.9)\n")
} else if (auc_valid >= 0.8) {
  cat("âœ… Bonne capacitÃ© de discrimination (0.8 â‰¤ AUC < 0.9)\n")
} else if (auc_valid >= 0.7) {
  cat("âš   CapacitÃ© de discrimination acceptable (0.7 â‰¤ AUC < 0.8)\n")
} else {
  cat("âŒ Faible capacitÃ© de discrimination (AUC < 0.7)\n")
}

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  8. VISUALISATIONS AMÃ‰LIORÃ‰ES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ“Š Ã‰TAPE 7: CRÃ‰ATION DES VISUALISATIONS AMÃ‰LIORÃ‰ES\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# ThÃ¨me personnalisÃ© pour tous les graphiques
theme_custom <- theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", color = colors_palette$dark_blue),
    plot.subtitle = element_text(hjust = 0.5, size = 12, color = colors_palette$primary),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major = element_line(color = "grey90", size = 0.5),
    panel.grid.minor = element_line(color = "grey95", size = 0.3),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  )

# 1. Distribution de la variable rÃ©ponse - Version amÃ©liorÃ©e
awards_data <- data.frame(Awards = df$Awards)
p1 <- ggplot(awards_data, aes(x = factor(Awards))) +
  geom_bar(fill = colors_palette$primary, alpha = 0.8, color = "white", size = 0.7) +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.5, 
            color = colors_palette$dark_blue, fontface = "bold") +
  labs(title = "Distribution du nombre de prix remportÃ©s",
       subtitle = paste("Analyse de", nrow(df), "observations"),
       x = "Nombre de prix", y = "FrÃ©quence") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_custom

# 2. PrÃ©dictions vs Observations - Version amÃ©liorÃ©e
df_pred <- data.frame(
  observed = c(df_train$Awards, df_valid$Awards),
  predicted = c(pred_train, pred_valid),
  dataset = c(rep("Apprentissage", nrow(df_train)), 
              rep("Validation", nrow(df_valid)))
)

p2 <- ggplot(df_pred, aes(x = observed, y = predicted, color = dataset)) +
  geom_point(alpha = 0.7, size = 2.5) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = colors_palette$secondary, size = 1) +
  scale_color_manual(values = c("Apprentissage" = colors_palette$primary, 
                               "Validation" = colors_palette$accent),
                    name = "Ã‰chantillon") +
  labs(title = "Valeurs prÃ©dites vs observÃ©es",
       subtitle = "Ligne pointillÃ©e = prÃ©diction parfaite",
       x = "Valeurs observÃ©es", y = "Valeurs prÃ©dites") +
  theme_custom +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 1)))

# 3. Courbe ROC - Version amÃ©liorÃ©e
roc_data <- data.frame(
  specificite = c(roc_train$specificities, roc_valid$specificities),
  sensibilite = c(roc_train$sensitivities, roc_valid$sensitivities),
  dataset = c(rep("Apprentissage", length(roc_train$specificities)),
              rep("Validation", length(roc_valid$specificities)))
)

p3 <- ggplot(roc_data, aes(x = 1 - specificite, y = sensibilite, color = dataset)) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50", size = 1) +
  scale_color_manual(values = c("Apprentissage" = colors_palette$primary, 
                               "Validation" = colors_palette$success),
                    name = "Ã‰chantillon") +
  labs(title = "Courbes ROC - CapacitÃ© de discrimination",
       subtitle = paste("AUC Apprentissage:", round(auc_train, 3), "| AUC Validation:", round(auc_valid, 3)),
       x = "1 - SpÃ©cificitÃ© (Taux de faux positifs)", 
       y = "SensibilitÃ© (Taux de vrais positifs)") +
  coord_equal() +
  theme_custom +
  guides(color = guide_legend(override.aes = list(size = 3)))

# 4. RÃ©sidus de Pearson - Version amÃ©liorÃ©e
df_resid <- data.frame(
  fitted = pred_train,
  pearson = residuals(mod_final, type = "pearson"),
  deviance = residuals(mod_final, type = "deviance")
)

p4 <- ggplot(df_resid, aes(x = fitted, y = pearson)) +
  geom_point(alpha = 0.6, size = 2, color = colors_palette$primary) +
  geom_hline(yintercept = 0, color = colors_palette$secondary, linetype = "dashed", size = 1) +
  geom_smooth(method = "loess", se = TRUE, color = colors_palette$warning, 
              fill = colors_palette$warning, alpha = 0.2, size = 1) +
  labs(title = "Diagnostic des rÃ©sidus de Pearson",
       subtitle = "VÃ©rification de l'homoscÃ©dasticitÃ©",
       x = "Valeurs ajustÃ©es", y = "RÃ©sidus de Pearson standardisÃ©s") +
  theme_custom

# Sauvegarde des graphiques principaux
ggsave("01_distribution_awards.png", p1, path = out_dir, 
       width = 12, height = 8, units = "in", dpi = 300, bg = "white")
ggsave("02_predictions_vs_observations.png", p2, path = out_dir, 
       width = 12, height = 8, units = "in", dpi = 300, bg = "white")
ggsave("03_courbe_roc.png", p3, path = out_dir, 
       width = 12, height = 8, units = "in", dpi = 300, bg = "white")
ggsave("04_residus_pearson.png", p4, path = out_dir, 
       width = 12, height = 8, units = "in", dpi = 300, bg = "white")

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  GRAPHIQUES DIAGNOSTIQUES SÃ‰PARÃ‰S  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("ðŸ“Š CrÃ©ation des graphiques diagnostiques sÃ©parÃ©s...\n")

# PrÃ©paration des donnÃ©es pour les diagnostiques
fitted_values <- fitted(mod_final)
residuals_pearson <- residuals(mod_final, type = "pearson")
residuals_deviance <- residuals(mod_final, type = "deviance")
residuals_standardized <- rstandard(mod_final)
leverage <- hatvalues(mod_final)
cooksd <- cooks.distance(mod_final)

# 1. RÃ©sidus vs Valeurs ajustÃ©es
p_diag1 <- ggplot(data.frame(fitted = fitted_values, residuals = residuals_pearson), 
                  aes(x = fitted, y = residuals)) +
  geom_point(color = colors_palette$primary, alpha = 0.6, size = 2) +
  geom_hline(yintercept = 0, color = colors_palette$secondary, linetype = "dashed", size = 1) +
  geom_smooth(method = "loess", se = TRUE, color = colors_palette$warning, 
              fill = colors_palette$warning, alpha = 0.2) +
  labs(title = "RÃ©sidus vs Valeurs ajustÃ©es",
       subtitle = "VÃ©rification de la linÃ©aritÃ© et homoscÃ©dasticitÃ©",
       x = "Valeurs ajustÃ©es", y = "RÃ©sidus de Pearson") +
  theme_custom

# 2. Q-Q Plot des rÃ©sidus
sample_quantiles <- sort(residuals_standardized)
theoretical_quantiles <- qnorm(ppoints(length(sample_quantiles)))
qq_data <- data.frame(theoretical = theoretical_quantiles, sample = sample_quantiles)

p_diag2 <- ggplot(qq_data, aes(x = theoretical, y = sample)) +
  geom_point(color = colors_palette$primary, alpha = 0.7, size = 2) +
  geom_abline(slope = 1, intercept = 0, color = colors_palette$secondary, 
              linetype = "dashed", size = 1) +
  labs(title = "Q-Q Plot des rÃ©sidus standardisÃ©s",
       subtitle = "VÃ©rification de la normalitÃ© des rÃ©sidus",
       x = "Quantiles thÃ©oriques", y = "Quantiles observÃ©s") +
  theme_custom

# 3. Scale-Location (racine des rÃ©sidus standardisÃ©s)
p_diag3 <- ggplot(data.frame(fitted = fitted_values, 
                            sqrt_std_resid = sqrt(abs(residuals_standardized))), 
                  aes(x = fitted, y = sqrt_std_resid)) +
  geom_point(color = colors_palette$success, alpha = 0.6, size = 2) +
  geom_smooth(method = "loess", se = TRUE, color = colors_palette$info, 
              fill = colors_palette$info, alpha = 0.2) +
  labs(title = "Scale-Location Plot",
       subtitle = "VÃ©rification de l'homoscÃ©dasticitÃ©",
       x = "Valeurs ajustÃ©es", y = "âˆš|RÃ©sidus standardisÃ©s|") +
  theme_custom

# 4. Distance de Cook
n_obs <- length(cooksd)
p_diag4 <- ggplot(data.frame(index = 1:n_obs, cooks_d = cooksd), 
                  aes(x = index, y = cooks_d)) +
  geom_segment(aes(xend = index, yend = 0), color = colors_palette$primary, alpha = 0.7) +
  geom_point(color = colors_palette$secondary, size = 2, alpha = 0.8) +
  geom_hline(yintercept = 4/n_obs, color = colors_palette$warning, 
             linetype = "dashed", size = 1) +
  labs(title = "Distance de Cook",
       subtitle = "DÃ©tection des observations influentes",
       x = "Index des observations", y = "Distance de Cook") +
  theme_custom

# 5. RÃ©sidus vs Leverage
p_diag5 <- ggplot(data.frame(leverage = leverage, std_resid = residuals_standardized, 
                            cooks_d = cooksd), 
                  aes(x = leverage, y = std_resid)) +
  geom_point(aes(size = cooks_d), color = colors_palette$primary, alpha = 0.7) +
  geom_hline(yintercept = c(-2, 0, 2), color = colors_palette$secondary, 
             linetype = c("dashed", "solid", "dashed"), size = 1) +
  geom_vline(xintercept = 2 * length(coef(mod_final)) / n_obs, 
             color = colors_palette$warning, linetype = "dashed", size = 1) +
  scale_size_continuous(name = "Distance\nde Cook", range = c(1, 4)) +
  labs(title = "RÃ©sidus vs Leverage",
       subtitle = "Identification des points de levier et influents",
       x = "Leverage", y = "RÃ©sidus standardisÃ©s") +
  theme_custom

# 6. Histogramme des rÃ©sidus
p_diag6 <- ggplot(data.frame(residuals = residuals_standardized), aes(x = residuals)) +
  geom_histogram(bins = 20, fill = colors_palette$primary, alpha = 0.7, 
                 color = "white", size = 0.5) +
  geom_density(aes(y = after_stat(density) * length(residuals_standardized) * 
                   diff(range(residuals_standardized)) / 20), 
               color = colors_palette$secondary, size = 1.2) +
  labs(title = "Distribution des rÃ©sidus standardisÃ©s",
       subtitle = "VÃ©rification de la normalitÃ©",
       x = "RÃ©sidus standardisÃ©s", y = "FrÃ©quence") +
  theme_custom

# Sauvegarde des graphiques diagnostiques sÃ©parÃ©s
ggsave("05_diagnostic_residus_vs_fitted.png", p_diag1, path = out_dir, 
       width = 10, height = 7, units = "in", dpi = 300, bg = "white")
ggsave("06_diagnostic_qq_plot.png", p_diag2, path = out_dir, 
       width = 10, height = 7, units = "in", dpi = 300, bg = "white")
ggsave("07_diagnostic_scale_location.png", p_diag3, path = out_dir, 
       width = 10, height = 7, units = "in", dpi = 300, bg = "white")
ggsave("08_diagnostic_cooks_distance.png", p_diag4, path = out_dir, 
       width = 10, height = 7, units = "in", dpi = 300, bg = "white")
ggsave("09_diagnostic_residus_vs_leverage.png", p_diag5, path = out_dir, 
       width = 10, height = 7, units = "in", dpi = 300, bg = "white")
ggsave("10_diagnostic_histogramme_residus.png", p_diag6, path = out_dir, 
       width = 10, height = 7, units = "in", dpi = 300, bg = "white")

# Graphique combinÃ© des diagnostiques (optionnel)
p_combined <- grid.arrange(p_diag1, p_diag2, p_diag3, p_diag4, ncol = 2, nrow = 2,
                          top = "Diagnostiques du modÃ¨le de rÃ©gression de Poisson")
ggsave("11_diagnostics_combines.png", p_combined, path = out_dir, 
       width = 16, height = 12, units = "in", dpi = 300, bg = "white")

cat("âœ… Graphiques diagnostiques sÃ©parÃ©s crÃ©Ã©s avec succÃ¨s\n")

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  9. INTERPRÃ‰TATION DES RÃ‰SULTATS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ“ Ã‰TAPE 8: INTERPRÃ‰TATION DES RÃ‰SULTATS\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# Coefficients avec intervalles de confiance
coef_table <- tidy(mod_final, conf.int = TRUE, exponentiate = TRUE)
cat("ðŸ“Š COEFFICIENTS DU MODÃˆLE (avec exponentielles) :\n")
print(coef_table)

cat("\nðŸ” INTERPRÃ‰TATION DES COEFFICIENTS :\n")
for(i in 2:nrow(coef_table)) {  # Exclut l'intercept
  var_name <- coef_table$term[i]
  estimate <- coef_table$estimate[i]
  p_value <- coef_table$p.value[i]
  
  if(p_value < 0.05) {
    if(estimate > 1) {
      cat("â€¢", var_name, ": Augmentation de", round((estimate-1)*100, 1), 
          "% du nombre de prix (p <", round(p_value, 3), ")\n")
    } else {
      cat("â€¢", var_name, ": Diminution de", round((1-estimate)*100, 1), 
          "% du nombre de prix (p <", round(p_value, 3), ")\n")
    }
  } else {
    cat("â€¢", var_name, ": Effet non significatif (p =", round(p_value, 3), ")\n")
  }
}

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  10. SAUVEGARDE ET RAPPORT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ##
cat("\nðŸ’¾ Ã‰TAPE 9: SAUVEGARDE DES RÃ‰SULTATS\n")
cat("-" %+% paste(rep("-", 50), collapse = ""), "\n")

# Sauvegarde des objets R
save(mod_final, df_train, df_valid, pred_train, pred_valid,
     roc_train, roc_valid, auc_train, auc_valid,
     phi, coef_table, mse_train, mse_valid, mae_train, mae_valid,
     file = file.path(out_dir, "resultats_tp_poisson.RData"))

# Rapport de synthÃ¨se
sink(file.path(out_dir, "rapport_synthese.txt"))
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("                    RAPPORT DE SYNTHÃˆSE\n")
cat("                 RÃ‰GRESSION DE POISSON - TP\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")
cat("Date d'analyse :", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("Auteur : [Votre nom]\n\n")

cat("1. DONNÃ‰ES\n")
cat("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
cat("Nombre total d'observations :", nrow(df), "\n")
cat("Nombre de variables :", ncol(df), "\n")
cat("Ã‰chantillon d'apprentissage :", nrow(df_train), "observations\n")
cat("Ã‰chantillon de validation :", nrow(df_valid), "observations\n\n")

cat("2. MODÃˆLE RETENU\n")
cat("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
cat("Variables explicatives :", paste(names(coef(mod_final))[-1], collapse = ", "), "\n")
cat("AIC :", round(AIC(mod_final), 2), "\n")
cat("ParamÃ¨tre de dispersion (Ï†) :", round(phi, 4), "\n\n")

cat("3. PERFORMANCE\n")
cat("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
cat("MSE (validation) :", round(mse_valid, 3), "\n")
cat("MAE (validation) :", round(mae_valid, 3), "\n")
cat("RÂ² (validation) :", round(r2_valid, 3), "\n")
cat("AUC (validation) :", round(auc_valid, 3), "\n\n")

cat("4. COEFFICIENTS SIGNIFICATIFS\n")
cat("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
sig_coef <- coef_table[coef_table$p.value < 0.05, ]
for(i in 1:nrow(sig_coef)) {
  cat(sig_coef$term[i], ": exp(Î²) =", round(sig_coef$estimate[i], 4), 
      "(p <", round(sig_coef$p.value[i], 3), ")\n")
}

cat("\n5. CONCLUSION\n")
cat("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
if(auc_valid >= 0.8) {
  cat("Le modÃ¨le prÃ©sente une bonne capacitÃ© prÃ©dictive (AUC â‰¥ 0.8).\n")
} else {
  cat("Le modÃ¨le prÃ©sente une capacitÃ© prÃ©dictive limitÃ©e (AUC < 0.8).\n")
}

if(phi <= 1.5) {
  cat("L'hypothÃ¨se de dispersion de Poisson est respectÃ©e.\n")
} else {
  cat("Sur-dispersion dÃ©tectÃ©e - considÃ©rer un modÃ¨le alternatif.\n")
}

cat("\n6. QUALITÃ‰ DES GRAPHIQUES\n")
cat("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
cat("âœ… Graphiques avec palette de couleurs professionnelle\n")
cat("âœ… Diagnostiques sÃ©parÃ©s pour une meilleure lisibilitÃ©\n")
cat("âœ… ThÃ¨me personnalisÃ© cohÃ©rent sur tous les graphiques\n")
cat("âœ… RÃ©solution haute dÃ©finition (300 DPI)\n")
cat("âœ… Annotations et sous-titres informatifs\n")
sink()

cat("âœ… Rapport de synthÃ¨se crÃ©Ã©\n")
cat("âœ… Tous les rÃ©sultats sauvegardÃ©s dans :", out_dir, "\n\n")
cat("ðŸ“ FICHIERS CRÃ‰Ã‰S (VERSION AMÃ‰LIORÃ‰E) :\n")
cat("   ðŸ“Š GRAPHIQUES PRINCIPAUX :\n")
cat("   â€¢ 01_distribution_awards.png (avec compteurs et couleurs)\n")
cat("   â€¢ 02_predictions_vs_observations.png (couleurs distinctes par Ã©chantillon)\n")
cat("   â€¢ 03_courbe_roc.png (avec AUC dans le sous-titre)\n")
cat("   â€¢ 04_residus_pearson.png (avec bande de confiance)\n\n")
cat("   ðŸ” DIAGNOSTIQUES SÃ‰PARÃ‰S :\n")
cat("   â€¢ 05_diagnostic_residus_vs_fitted.png\n")
cat("   â€¢ 06_diagnostic_qq_plot.png\n")
cat("   â€¢ 07_diagnostic_scale_location.png\n")
cat("   â€¢ 08_diagnostic_cooks_distance.png\n")
cat("   â€¢ 09_diagnostic_residus_vs_leverage.png\n")
cat("   â€¢ 10_diagnostic_histogramme_residus.png\n")
cat("   â€¢ 11_diagnostics_combines.png (vue d'ensemble)\n\n")
cat("   ðŸ“‹ AUTRES FICHIERS :\n")
cat("   â€¢ resultats_tp_poisson.RData\n")
cat("   â€¢ rapport_synthese.txt\n\n")

cat("ðŸŽ¨ AMÃ‰LIORATIONS APPORTÃ‰ES :\n")
cat("   âœ… Palette de couleurs professionnelle et cohÃ©rente\n")
cat("   âœ… Graphiques diagnostiques sÃ©parÃ©s pour meilleure analyse\n")
cat("   âœ… ThÃ¨me personnalisÃ© avec police et mise en forme amÃ©liorÃ©es\n")
cat("   âœ… Annotations enrichies et sous-titres informatifs\n")
cat("   âœ… RÃ©solution HD (300 DPI) avec fond blanc\n")
cat("   âœ… LÃ©gendes et guides visuels optimisÃ©s\n")
cat("   âœ… Transparence et tailles ajustÃ©es pour meilleure lisibilitÃ©\n")
cat("   âœ… Ajout d'histogramme des rÃ©sidus pour diagnostic complet\n\n")

cat("ðŸŽ‰ ANALYSE TERMINÃ‰E AVEC SUCCÃˆS - VERSION AMÃ‰LIORÃ‰E !\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")


```


